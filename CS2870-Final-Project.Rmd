---
title: "CS2870-Final-Project"
output: pdf_document
authors: Yoni Masha, Charlie Corriero 
date: "2023-11-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, dplyr, usmap, maps, ggthemes, sf, lubridate, scales)
crime_data_sample <- read_csv("Crime_Data_from_2020_to_Present (1).csv")

us_states <- map_data(map = "state")
us_counties <- map_data(map = "county")

theme_set(theme_map())
```


## Intro

The source for our data is kaggle.com and the data set was created on October 12, 2023. This data is not a sample as it is all the crime data from the year 2020 to the present (2023), and because of this, it does not have any sampling bias. The data from this set was collected from data.gov and was created in November of 2020 and has been regularly updated since, and is maintained by LAPD OpenData. This was an observational study looking at all the crimes that occurred from 2020-2023. This data is of interest to us because we think that analyzing crime data could help people to better understand when/where/why crimes occur and what can be predicted based on the data. As for cleaning the data, we first cut the data set in half because it was too large and making graphs, manipulating the data, etc was taking longer than we wanted. Next we used dplyr::select() to keep the columns that we thought were relevant to the graphs we were going to make and the machine learning we planned to implement. After that we used rename() to rename the columns to something more readable and intuitive and used mutate() to remove unnecessary white space from our 'location' column. Lastly, we used filter to keep the rows where the age was in the range we wanted (0 to 90), the latitude and longitude weren't equal to zero, and the rows did not contain NA or no value.


```{r cleaning}
RNGversion("4.1.0"); set.seed(2870)

crime_data_sample |>
  slice_sample(prop = 0.5)


crime_data_sample |>
  dplyr::select(`Date Rptd`, `DATE OCC`, `TIME OCC`, AREA, `AREA NAME`, `Crm Cd Desc`, `Vict Age`, `Vict Sex`, `Vict Descent`,
                `Premis Desc`, `Weapon Desc`, `Status Desc`, LOCATION, LAT, LON) |>
  rename(
    "date_reported" = `Date Rptd`, 
    "date_occurred" = `DATE OCC`,
    "time_occurred" = `TIME OCC`,
    "area" = AREA,
    "area_name" = `AREA NAME`,
    "crime_description" = `Crm Cd Desc`,
    "victim_age" = `Vict Age`,
    "victim_sex" = `Vict Sex`,
    "victim_descent" = `Vict Descent`,
    "premise_desc" = `Premis Desc`,
    "weapon_desc" = `Weapon Desc`,
    "status" = `Status Desc`,
    "location" = LOCATION,
    "lat" = LAT,
    "long" = LON
  ) |>
  
  mutate(location = str_squish(location)) |>
  
  filter(
    victim_age > 0 & victim_age <= 90,
    !is.na(victim_sex),
    !is.na(victim_descent),
    !is.na(date_reported),
    !is.na(date_occurred),
    !is.na(time_occurred),
    !is.na(area),
    !is.na(area_name),
    !is.na(crime_description),
    !is.na(premise_desc),
    !is.na(victim_age),
    !is.na(status),
    !is.na(location),
    lat != 0 & long != 0,
    !is.na(lat),
    !is.na(long)
  ) |>
  
  slice_sample(prop = .5) ->
  
  crime_data

```


```{r victim_sex/crime analysis}

ggplot(
  data = crime_data,
  mapping = aes(
    x = victim_age
  ),
) +
  
  geom_histogram(
    color = "black",
    fill = "firebrick"
  ) +
  
  labs(
    x = "Age of Victim",
    y = "Number of Crimes",
    title = "Number of Crimes Committed on People of Age X"
  ) +
  
  theme(
    plot.background = element_rect(fill = "gray17"),
    panel.background = element_rect(fill = "gray17"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(color = "gray"),
    axis.line.x = element_line(color = "gray"),
    axis.line.y = element_line(color = "gray"),
    axis.title.x = element_text(color = "gray"),
    axis.title.y = element_text(color = "gray"),
    plot.title = element_text(color = "gray", hjust = .5)
  ) +
  
  scale_y_continuous(
    expand = c(0,0,0.25,0),
    breaks = c(0,5000,10000,15000,20000,25000,30000)
  ) +
  
  scale_x_continuous(
    expand = c(0.025,0.05,0.05,0),
    breaks = c(0,10,20,30,40,50,60,70,80,90)
  )

```


```{r density usa map crimes}

crime_data |>
  slice_sample(n = 1000) ->
  crime_slice



# Found online
circle_center <- c(20, 200)
circle_radius <- 50

# Create a data frame with the circle coordinates
circle_data <- data.frame(
  x = circle_center[1],
  y = circle_center[2],
  radius = circle_radius
)



ggplot(
  data = us_states,
  mapping = aes(
    x = long,
    y = lat,
    group = group
  )
) +

  # Use geom_polygon to draw the lines for each state
  geom_polygon(
    color = "black",
    fill = "white"
  ) + 
  
  # Add the correct theme below
  theme_map() +
   
  # Add this function to make the map look more like what it would be on a globe
  coord_map(projection = "albers", 
            lat0 = 39, lat1 = 45) +
  
  geom_point(
    data = crime_slice,
    mapping = aes(
      x = long,
      y = lat,
      group = area_name
    )
  ) +
  
  scale_x_continuous(
    expand = c(0,0)
  ) +
  
  scale_y_continuous(
    expand = c(0,0)
  ) +
  
  labs(title = expression("Our map graph before we realized that our crime data is" ~ italic("only") ~ " crimes commited in Los Angeles")) +
  theme(plot.title = element_text(hjust = .5, size = 12))

```



```{r time of day for crime}
# Making a new data-frame for the times and converting them from military to regular
crime_data |>
  dplyr::select(time_occurred, ) |>
  
  group_by(time_occurred) |>
  
  mutate(time_occurred = floor(as.numeric(time_occurred) / 100) * 100,
         occurrences = n()) |>
  
  distinct(time_occurred,.keep_all = TRUE) |>
  
  ungroup() ->
  crime_times



# Creating 2 vectors, one for the labels for the graph and one for the breaks on the graph
time_labels <- c("12pm", "1am", "2am", "3am", "4am", "5am", "6am", "7am", "8am", "9am", "10am", "11am", "12am", "1pm", "2pm", "3pm", "4pm", "5pm", "6pm", "7pm", "8pm", "9pm", "10pm", "11pm")
time_breaks <- seq(from = 0, to = 2300, by = 100)

# Creating the graoh
ggplot(data = crime_times,
       mapping = aes(
         x = time_occurred,
         y = occurrences,
         fill = occurrences
       )) +
  
  # Adding the columns
  geom_col() +
  
  # Setting the base theme
  theme_bw() +
  
  # Using the previously made vectors to set the breaks and labels
  scale_x_continuous(breaks = time_breaks,
                     labels = time_labels,
                     minor_breaks = F,
                     expand = c(0.01,0.01)) +
  
  scale_y_continuous(expand = c(0,0,0.03,0)) +
  
  # Setting the title, x and y axis labels, and legend title
  labs(x = "Time",
       y = "Number of crimes that occured",
       title = "Number of Crimes that Occurred During Each Hour",
       fill = 'Occurences') + 
  
  theme(
        # Text elements
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.text = element_text(color = "gray"),
        legend.title = element_text(color = "gray"),
        plot.title = element_text(hjust=0.5, size = 15, color = "gray"),
        axis.text = element_text(color = "gray"),
        
        # Rect elements
        legend.background = element_rect(fill = "gray17"),
        panel.background = element_rect(fill = "gray17"),
        plot.background = element_rect(fill = "gray17"),
        
        # Blank elements
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        
        # Line elements
        axis.line.x = element_line(color = "gray"),
        axis.line.y = element_line(color = "gray"),
        axis.title.x = element_text(color = "gray"),
        axis.title.y = element_text(color = "gray"),
        
        # Other elements
        legend.key.height = unit(1, "cm")
        ) +
  

  # Changing the breaks, labels, and colors for the graph  
  scale_fill_gradient(low = "green", high = "red",
                      limits = c(0, 7500), 
                      breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000, 7000),
                      labels = c(0, 1000, 2000, 3000, 4000, 5000, 6000, 7000))

```


```{r descent bar plot}

crime_data_descent <-
  
  crime_data |>
  
  group_by(victim_descent) |>
  
  mutate(
    occurrences = n()
  ) |>
  
  distinct(victim_descent,.keep_all = TRUE) |>
  
  select(victim_descent, occurrences)
  

ggplot(
  data = crime_data_descent,
  mapping = aes(
    y = reorder(x = victim_descent, X = occurrences),
    x = occurrences,
    fill = occurrences,
    label = occurrences
  )
) +
  
  geom_col() +
  
  geom_text(
    aes(x = occurrences + 5000, label = occurrences),
    color = "white", 
    size = 3.25  
  ) +
  
  theme_bw() +
  
  theme(
    plot.title = element_text(color = "gray" ,hjust = 0.5),
    plot.background = element_rect(fill = "gray17"),
    panel.background = element_rect(fill = "gray17"),
    axis.text = element_text(color = "gray"),
    axis.line.x = element_line(color = "gray"),
    axis.line.y = element_line(color = "gray"),
    axis.title.x = element_text(color = "gray"),
    axis.title.y = element_text(color = "gray"),
    axis.ticks.y = element_line(color = "gray"),
    axis.ticks.x = element_line(color = "gray"),
    legend.position = "none",
    panel.grid.major.x = element_line(color = "gray30"),
    panel.grid.major.y = element_line(color = "gray30"),
    panel.grid.minor.x =element_line(color = "gray30")
  ) +
  
  labs(
    x = "Crimes Commited",
    y = "Victim Descent",
    title = "Number of Crimes Against Victim Based on Descent in LA"
  ) +

  scale_y_discrete(
    labels = c(
      "H" = "Hispanic",
      "B" = "Black",
      "O" = "Other",
      "A" = "Other Asian",
      "W" = "White",
      "X" = "Unknown",
      "K" = "Korean",
      "F" = "Filipino",
      "C" = "Chinese",
      "J" = "Japanese",
      "V" = "Viatnamese",
      "I" = "American Indian/\nAlaskan Native",
      "Z" = "Asian Indian",
      "P" = "Pacific Islander",
      "U" = "Hawaiian",
      "G" = "Guamanian",
      "D" = "Cambodian",
      "S" = "Samoan",
      "L" = "Laotian"
    ),
    expand = c(0,0,0,0)
  ) +
  
  scale_fill_gradient(
    low = "gold",
    high = "firebrick1"  
  ) +
  
  scale_x_continuous(
    expand = c(0.0075,0,0.05,0),
    breaks = c(0,25000,50000,75000,100000,125000,150000)
  )

#Vict Descent - Descent Code: A - Other Asian B - Black C - Chinese D - Cambodian F - Filipino G - Guamanian H - #Hispanic/Latin/Mexican I - American Indian/Alaskan Native J - Japanese K - Korean L - Laotian O - Other P - Pacific #Islander S - Samoan U - Hawaiian V - Vietnamese W - White X - Unknown Z - Asian Indian



```


``` {r idk soem graph}

crime_data_date <- 
  crime_data |>
  
  mutate(date = as.Date(date_occurred, format = "%m/%d/%Y %I:%M:%S %p"),
         months_since_2020 = (year(date) - 2020) * 12 + month(date)) |>
  
  filter((victim_sex == "M" | victim_sex == "F") & months_since_2020 <= 45)



crime_summarized <- crime_data_date |>
  
  group_by(months_since_2020, victim_sex) |>
  
  summarise(crime_count = n())

ggplot(
  data = crime_summarized,
  mapping = aes(
    x = months_since_2020,
    y = crime_count,
    group = victim_sex,
    color = victim_sex
  )
) +
  
  geom_line() +
  
  
  theme_classic() +
  
  labs(
    x = "Months since January 2020",
    y = "Crime Count",
    color = "Victim Sex",
    title = "Number of Crimes Commited Against Each Sex Since 2020"
  ) +
  
  theme(
    plot.title = element_text(color = "gray" ,hjust = 0.5),
    legend.position = c(0.75, 0.25),
    plot.background = element_rect(fill = "gray17"),
    panel.background = element_rect(fill = "gray17"),
    axis.text = element_text(color = "gray"),
    axis.line.x = element_line(color = "gray"),
    axis.line.y = element_line(color = "gray"),
    axis.title.x = element_text(color = "gray"),
    axis.title.y = element_text(color = "gray"),
    legend.background = element_rect(fill = "gray17"),
    legend.title = element_text(color = "gray"),
    legend.text = element_text(color = "gray")
  ) +
  
  scale_x_continuous(
    expand = c(0,0,0,0),
    breaks = c(seq(0,50,5))
  ) +
  
  scale_y_continuous(
    expand = c(0.05,0,0.05,0),
    breaks = c(seq(2500,4000,250))
  ) +
  
  scale_color_manual(
    values = c("M" = "steelblue1", "F" = "hotpink"),
    labels = c("F" = "Female", "M" = "Male")
  )


```
In this graph, we observe the number of crimes committed on male and female persons since 2020. The part that strikes me about this graph is during the time of the pandemic both male and female crimes drop significantly. We can also observe that around a year and a half later (15 months on this graph) the crimes start to pick up again which is when mandates started to become more lenient and people were leaving there houses more and more. 

Although it makes sense in this graph that males are on the receiving end of most crimes, it strikes me that females around 2 years after 2020 start to experience more crimes than the males, even spiking at around 34 months. I don't think there is any particular causation of this, but it is interesting nonetheless. Finally, there is a significant drop off at 45 months, but that is most likely because crimes were not reported as much because of the new year. 

``` {r dumbbell plot age, gender, and crime}
crime_data |>
  
  group_by(victim_sex) |> 
  
  mutate(
    condensed_crime = case_when(
      grepl("battery&sexual|sex|lewd|indecent|peeping|oral", tolower(crime_description)) ~ "Sexual Assault",
      grepl("assault|battery", tolower(crime_description)) ~ "Assault",
      grepl("robbery|theft|extortion|stolen|stole|steal|pickpocket", tolower(crime_description)) ~ "Robbery",
      grepl("rape", tolower(crime_description)) ~ "Rape",
      grepl("vandalism", tolower(crime_description)) ~ "Vandalism",
      grepl("trespassing", tolower(crime_description)) ~ "Tresspassing",
      grepl("arson", tolower(crime_description)) ~ "Arson",
      grepl("neglect|abuse", tolower(crime_description)) ~ "Abuse/Neglect",
      grepl("weapon|firearm|bomb", tolower(crime_description)) ~ "Weapons Related",
      grepl("kidnap|child steal", tolower(crime_description)) ~ "Kidnapping"
    )
  ) |>
  
  group_by(condensed_crime) |>
  
  summarise(
    avg_age_male = mean(ifelse(victim_sex == "M" & !is.na(victim_age), victim_age, NA), na.rm = TRUE),
    avg_age_female = mean(ifelse(victim_sex == "F" & !is.na(victim_age), victim_age, NA), na.rm = TRUE)
  ) |>
  
  dplyr::select(condensed_crime, avg_age_male, avg_age_female) |>
  
  filter(!is.na(condensed_crime)) |>
  
  distinct(condensed_crime, .keep_all = T) ->
  
  crime_data_crimes_clean


ggplot(
  data = crime_data_crimes_clean,
  mapping = aes(
    y = fct_reorder(condensed_crime, avg_age_male, .fun = min)
  )
) +
  
  geom_segment(
    mapping = aes(
      x = avg_age_male, xend = avg_age_female, yend = condensed_crime
    ),
    color = "gray"
  ) +
  
  geom_point(
    mapping = aes(x = avg_age_female),
    color = "hotpink"
  ) +
  
  geom_point(
    mapping = aes(x = avg_age_male),
    color = "steelblue1"
  ) +
  
  theme_classic() +
  
  labs(
    title = "Female Avg Age Vs Male Avg Age For Each Crime",
    y = "Type of Crime",
    x = "Age"
  ) +
  
  theme(
    plot.title = element_text(color = "gray" ,hjust = 0.5),
    plot.background = element_rect(fill = "gray17"),
    panel.background = element_rect(fill = "gray17"),
    axis.text = element_text(color = "gray"),
    axis.line.x = element_line(color = "gray"),
    axis.line.y = element_line(color = "gray"),
    axis.title.x = element_text(color = "gray"),
    axis.title.y = element_text(color = "gray"),
    axis.ticks = element_blank()
  ) +
  
  scale_x_continuous(
    breaks = seq(0,50,5)
  )
```
